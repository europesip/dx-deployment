A.- LIMPIA Y BORRADO DE TODO LO ANTERIOR
Esta sección se encarga de la limpia y borrado de instalaciones previas
De esta forma, podemos hacer pruebas con la instalacion y repetirla varias veces

#Logeo como admin
oc login https://api.promox.europesip-lab.com:6443 -u kubeadmin

# Me situo en projecto digital-experience 
oc project digital-experience 

# Compruebo las instalaciones previas hechas
helm list

# borro la instalacion anterior
helm uninstall dx-deployment


# Comprueba si quedan PVCs y PV y borralos si es asi.
oc get pvc
oc delete pvc --all -n digital-experience  # Si existen pvcs, los borro
oc get pv
# Si existen, borro cualquier Volumen que haya visto en la anterior salida
# Para ello deberé ajustar los valores correspondientes 
oc delete pv \  
  pvc-272ca607-3d61-4178-ae6b-c3e680011b0a \
  pvc-50c04075-f1ca-4b53-bc39-d3d390a2207b \
  pvc-8edea03b-ded7-42c0-ab0a-de28e5818aed \
  pvc-db093249-4b07-4b49-96cd-cc24e107d6a2

# Compruebo que se hayan terminado de borrar los pods
oc get pods
# Compruebo si hay routas creadas
oc get routes
oc delete route dx-route # Si hay, las borro

# Finalmente me cargo el NameSpace entero
oc delete project digital-experience 


B).-  Pre-requisitos (como kubeadmin)
#Esta seccion corresponde a los pasos de preparacion del entorno que debe ejecutar
#previamente el administrador de openshit

# Logearme como kubeadmin
oc login https://api.promox.europesip-lab.com:6443 -u kubeadmin

# Comprobar quien soy
oc whoami

# Comprobar disponibilidad de recursos
 oc adm top
 
# Deberiamos tener al menos 2 cores disponibles y unos 8 gb de memoria ram
# Si no memoria o cpu, liberar recursos (o resetear workers)

# Crea namespace inicial
oc apply -f namespace-setup.yaml

# Me situo en dicho namespace
oc project digital-experience

#Asigna el rol admin al usuario dxadmin sobre este namespace (Acceso Limitado)
oc adm policy add-role-to-user admin dxadmin -n digital-experience 

# Crea la definición del ClusterRole de permisos extendidos
oc apply -f rbac-extended.yaml

# Vincula el rol para que dxadmin pueda gestionar los recursos sensibles.
oc adm policy add-role-to-user dx-installer-extra-perms dxadmin -n digital-experience

Si se necesita usar certificado pre-existente, copiar .pems

# Comprobar que tengo Sc
oc get Sc



2).- Instalacion (como dxadmin)

# Logearse como usuario instalador
oc login https://api.promox.europesip-lab.com:6443 -u dxadmin

# Comprobar que estoy logeado como usuario instalador
oc whoami

#Crear Key TLS & Secret
openssl genrsa -out my-key.pem 2048
openssl req -x509 -key my-key.pem -out my-cert.pem -days 365 -subj '/CN=EuropeSIP'
oc create secret tls dx-tls-cert --cert=my-cert.pem --key=my-key.pem -n digital-experience 

#Si necesario Crear PullSecret para autenticacion registro
#Check https://help.hcl-software.com/digital-experience/dx-compose/CF231/deploy_dx/install/kubernetes_deployment/preparation/optional_tasks/optional_imagepullsecrets/


# Command to extract values.yaml from Helm Chart
helm show values hcl-dx-deployment-2.42.1.tgz  > values.yaml
cp values.yaml custom-values.yaml

#Lanzar Installacion (previamente habre modificado custom_values.yaml)

helm install -n digital-experience  \
  -f custom-values.yaml \
  dx-deployment \
  ./hcl-dx-deployment-2.42.1.tgz \
  --timeout 20m \
  --wait

#Observar si los pods se crean
oc get pods
oc logs -f dx-deployment-web-engine-0 -c web-engine -n digital-experience 


# Comprobar que puedo entrar con un proxy forward al NodePort del HA-Proxy
oc port-forward svc/dx-deployment-haproxy 8443:30443

# Si es asi, crear routa acceso sin necesidad de proxy forward
 oc apply -f dx-haproxy-route.yaml 


# Si problemas, coger estos logs
export namespace="digital-experience"
export releasename="dx-deployment"
kubectl -n $namespace top nodes > topnodes.txt
kubectl -n $namespace top pods > toppods.txt
kubectl get events -n $namespace > events.txt
kubectl get pods -n $namespace -o wide > podStatus.txt
kubectl logs -n $namespace -l release=$releasename --all-containers --prefix=true --previous --tail=-1 > previousLogs.txt
kubectl logs -n $namespace -l release=$releasename --all-containers --prefix=true --tail=-1 > currentLogs.txt