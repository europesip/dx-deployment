schemaVersion: 2.2.0

metadata:
  name: hcl-dx-workspace-pro
  displayName: "HCL DX & React Environment"
  description: "Full Stack Environment with Java, React, HCL DXClient, and HCL DX Extensions."
  icon: "https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg"

components:
  - name: tools
    container:
      image: quay.io/agorostidi/europesip-udi-dx:latest
      memoryLimit: 6Gi
      mountSources: true

      # Keep the container alive to avoid CrashLoopBackoff
      command: ["/bin/sh", "-c", "tail -f /dev/null"]

      # Java & Node environment paths
      env:
        - name: JAVA_HOME
          value: /usr/lib/jvm/java-17-openjdk
        - name: PATH
          value: /usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin:/home/tooling/.nvm/versions/node/v20.18.1/bin

      # Exposed ports for development
      endpoints:
        - name: "react-app"
          targetPort: 3000
          exposure: public
          protocol: http
        - name: "vite-app"
          targetPort: 5173
          exposure: public
          protocol: http
        - name: "java-backend"
          targetPort: 8080
          exposure: public

commands:

  ###########################################################################
  # 1) Install LOCAL HCL DX extension
  #
  # NOTE:
  # - The HCL DX extension is NOT available in OpenVSX.
  # - Therefore, we install it using a local workaround from /opt/extensions.
  ###########################################################################
  - id: install-local-dx-extension
    exec:
      label: "ðŸ”§ Install Local HCL DX Extension (Workaround)"
      component: tools
      commandLine: |
        EXT_DIR="$HOME/.vscode/extensions"
        mkdir -p "$EXT_DIR"

        echo "--> Scanning /opt/extensions for HCL DX extensions..."

        for vsix in /opt/extensions/*hcl-dx*.vsix; do
          if [ -f "$vsix" ]; then
            NAME=$(basename "$vsix" .vsix)
            TARGET="$EXT_DIR/$NAME"

            # Cache: skip if already installed
            if [ -d "$TARGET" ]; then
              echo "âš ï¸  $NAME already installed. Skipping."
              continue
            fi

            echo "ðŸ“¦ Installing local HCL DX extension: $NAME"
            unzip -q "$vsix" -d "$TARGET.tmp"

            if [ -d "$TARGET.tmp/extension" ]; then
              mv "$TARGET.tmp/extension" "$TARGET"
              rm -rf "$TARGET.tmp"
              echo "   âœ”ï¸ Installed: $NAME"
            else
              echo "   âŒ Invalid VSIX format for: $NAME"
              rm -rf "$TARGET.tmp"
            fi
          fi
        done

        echo "ðŸŽ‰ Local HCL DX installation completed."


  ###########################################################################
  # 2) Initialize sample project
  ###########################################################################
  - id: init-sample-project
    exec:
      label: "ðŸš€ Initialize HCL DX Sample Project"
      component: tools
      workingDir: /projects
      commandLine: |
        SOURCE="/opt/samples/dx-create-script-app"
        DEST="/projects/dx-create-script-app"

        if [ -d "$DEST" ]; then
          echo "âš ï¸  Existing project detected at: $DEST"
        else
          echo "ðŸ“‚ Copying sample project..."
          cp -r "$SOURCE" "$DEST"
          echo "   âœ”ï¸ Project created at: $DEST"
        fi


  ###########################################################################
  # 3) Diagnostic version check
  ###########################################################################
  - id: check-versions
    exec:
      label: "ðŸ” Check Tool Versions"
      component: tools
      workingDir: /projects
      commandLine: |
        echo "--- JAVA VERSION ---"
        java -version
        echo "--- NODE VERSION ---"
        node -v
        echo "--- HCL DX CLIENT ---"
        dxclient --version


  ###########################################################################
  # 4) Start React application
  ###########################################################################
  - id: start-react
    exec:
      label: "â–¶ï¸ Start React App"
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: "npm start"


  ###########################################################################
  # 5) Install VSCode extensions from OpenVSX (Parallel + Cached + Background)
  #
  # IMPORTANT:
  # - Extensions are fetched **exclusively** from https://open-vsx.org
  # - EXCEPT the HCL DX extension, which is **not available** in OpenVSX
  #   â†’ installed via local workaround from /opt/extensions
  #
  # - Installation is launched in BACKGROUND so DevSpaces won't timeout
  # - Log is persisted at: $HOME/.vscode/logs/openvsx-install.log
  ###########################################################################
  - id: install-openvsx-extensions
    exec:
      label: "ðŸ”Œ Install VSCode Extensions (OpenVSX, Background Mode)"
      component: tools
      commandLine: |
        (
          mkdir -p "$HOME/.vscode/extensions"
          mkdir -p "$HOME/.vscode/logs"

          LOGFILE="$HOME/.vscode/logs/openvsx-install.log"

          echo "ðŸ”½ Installing VSCode extensions from OpenVSX..." > "$LOGFILE"

          install_vsix () {
            NAME="$1"
            URL="$2"
            TARGET="$HOME/.vscode/extensions/$NAME"

            if [ -d "$TARGET" ]; then
              echo "âš ï¸  $NAME already installed. Skipping." >> "$LOGFILE"
              return
            fi

            echo "ðŸ“¦ Installing $NAME..." >> "$LOGFILE"

            wget -q "$URL" -O /tmp/ext.vsix
            unzip -q /tmp/ext.vsix -d "$TARGET.tmp"

            if [ -d "$TARGET.tmp/extension" ]; then
              mv "$TARGET.tmp/extension" "$TARGET"
              rm -rf "$TARGET.tmp"
              echo "   âœ”ï¸ Installed $NAME" >> "$LOGFILE"
            else
              echo "   âŒ Invalid VSIX for $NAME" >> "$LOGFILE"
              rm -rf "$TARGET.tmp"
            fi
          }

          # Java
          install_vsix "redhat.java" \
            "https://open-vsx.org/api/redhat/java/latest/file/redhat.java.vsix"

          # Java Debug
          install_vsix "vscjava.vscode-java-debug" \
            "https://open-vsx.org/api/vscjava/vscode-java-debug/latest/file/vscjava.vscode-java-debug.vsix"

          # Maven
          install_vsix "vscjava.vscode-maven" \
            "https://open-vsx.org/api/vscjava/vscode-maven/latest/file/vscjava.vscode-maven.vsix"

          # React Snippets
          install_vsix "dsznajder.es7-react-js-snippets" \
            "https://open-vsx.org/api/dsznajder/es7-react-js-snippets/latest/file/dsznajder.es7-react-js-snippets.vsix"

          # Angular
          install_vsix "Angular.ng-template" \
            "https://open-vsx.org/api/Angular/ng-template/latest/file/Angular.ng-template.vsix"

          # Prettier
          install_vsix "esbenp.prettier-vscode" \
            "https://open-vsx.org/api/esbenp/prettier-vscode/latest/file/esbenp.prettier-vscode.vsix"

          # ESLint
          install_vsix "dbaeumer.vscode-eslint" \
            "https://open-vsx.org/api/dbaeumer/vscode-eslint/latest/file/dbaeumer.vscode-eslint.vsix"

          # GitLens
          install_vsix "eamodio.gitlens" \
            "https://open-vsx.org/api/eamodio/gitlens/latest/file/eamodio.gitlens.vsix"

          # YAML
          install_vsix "redhat.vscode-yaml" \
            "https://open-vsx.org/api/redhat/vscode-yaml/latest/file/redhat.vscode-yaml.vsix"

          # Docker
          install_vsix "ms-azuretools.vscode-docker" \
            "https://open-vsx.org/api/ms-azuretools/vscode-docker/latest/file/ms-azuretools.vscode-docker.vsix"

          # EditorConfig
          install_vsix "EditorConfig.EditorConfig" \
            "https://open-vsx.org/api/EditorConfig/EditorConfig/latest/file/EditorConfig.EditorConfig.vsix"

          # Markdown All-in-One
          install_vsix "yzhang.markdown-all-in-one" \
            "https://open-vsx.org/api/yzhang/markdown-all-in-one/latest/file/yzhang.markdown-all-in-one.vsix"

          # HCL AppScan CodeSweep
          install_vsix "HCLTechnologies.hclappscancodesweep" \
            "https://open-vsx.org/api/HCLTechnologies/hclappscancodesweep/latest/file/HCLTechnologies.hclappscancodesweep.vsix"

          echo "ðŸŽ‰ Extension installation complete." >> "$LOGFILE"
        ) &

        echo "ðŸ”¥ Extensions installation started in background."
        echo "ðŸ“„ Log available at: ~/.vscode/logs/openvsx-install.log"


events:
  postStart:
    - install-local-dx-extension
    - install-openvsx-extensions